# Set up an AWS CodePipeline for CI/CD
* This document wil guide you through setting up a DevOps pipeline using AWS CodePipeline and deploying it onto AWS Elastic Beanstalk running an AWS managed Docker platform, deploying the app into a Docker container.

---

### Tech Stack
* ASP.NET Web API
* Docker
* AWS CodeBuild
* AWS CodeDeploy -> AWS Elastic Beanstalk

---

## Outline:
1. [Step 1: Setup `Dockerfile` & `buildspec.yml`](#step1)

* Once finished, you will have a Docker application running that automatically builds your software on commit, and deploys it to the Elastic beanstalk sitting behind a load balancer for scalability. This continuous integration pipeline will allow you to worry less about your deployments and get back to focusing on feature development within your application.


---

## Creating a working docker image <a name="step1"></a>
* Assume every file creation will be at the base of your root directory.
* Assume every file name is case sensitive.
1. Create a file called "Dockerfile" and write the following info:
```docker
#Getting .NET 6 runtime to just run our application
from mcr.microsoft.com/dotnet/aspnet:latest as runtime

# Setting our working directory
workdir /app

# Copying the publish folder generated by our CodeBuild
copy /publish ./

#Entrypoint to set that PokeApi.dll assembly will be our default entrypoint
entrypoint ["dotnet", "PokeApi.dll"]

#Expose to port 5000
expose 5000

#Changes the port from the runtime image to listen to 5000 (since by default it uses port 80)
env ASPNETCORE_URLS=http://+:5000
```
> ***How is the Dockerfile used?*** *The Dockerfile is a set of instructions that builds the image.* *During the **build** phase, managed by AWS CodeDeploy, we want to build an image defining the deployment environment (container) our app will run in within Elastic Beanstalk.*

2. Create a file called "buildspec.yml" and write the following info:
```YML
version: 0.2

phases:
  install:
    commands:
      - echo 'Installing dotNet 6'
      - /usr/local/bin/dotnet-install.sh --channel LTS

  pre_build:
    commands:
      - echo 'Restoring dependencies and unit testing'
      - dotnet restore
      - dotnet test --no-restore
  
  build:
    commands:
      - echo 'Building the app'
      - dotnet build

  post_build:
    commands:
      - echo 'Creating Publish folder for the app'
      - dotnet publish -c Release -o publish
  
artifacts:
  files:
    - 'Dockerfile'
    - publish/**/*
```

> ***How is the `buildspec.yml` file used?*** *You can read all about why this `buildspec` file is written the way it is [here](https://docs.aws.amazon.com/codebuild/latest/userguide/getting-started-cli-create-build-spec.html) :point_left: . Since we are using another computer to build our application, this file is used to tell the computer what exactly to execute in order for us to Build, Test, and Publish our application. Artifacts is used to tell the computer what exactly to give to our Elastic Beanstalk
